<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps API Test - Production Debugging</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        #map {
            width: 100%;
            height: 500px;
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #4338ca;
        }
        .test-results {
            margin-top: 20px;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ccc;
            background: #f9f9f9;
        }
        .test-item.pass {
            border-color: #4caf50;
        }
        .test-item.fail {
            border-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Google Maps API Production Test</h1>
        
        <div class="info-box">
            <h3>üìç Test Details</h3>
            <div><strong>Current URL:</strong> <span id="currentUrl"></span></div>
            <div><strong>API Key:</strong> <code>AIzaSyCwm4CExH0_hPj1a59BVcESE4bNrWJOepc</code></div>
            <div><strong>Test Time:</strong> <span id="testTime"></span></div>
        </div>

        <div id="status" class="status loading">
            ‚è≥ Initializing Google Maps API test...
        </div>

        <div class="test-results" id="testResults"></div>

        <div style="margin: 20px 0;">
            <button onclick="runDiagnostics()">üîç Run Full Diagnostics</button>
            <button onclick="testAPIKey()">üîë Test API Key</button>
            <button onclick="clearCache()">üóëÔ∏è Clear Cache & Reload</button>
        </div>

        <div id="map"></div>

        <div class="info-box" style="margin-top: 20px;">
            <h3>üîß Common Fixes</h3>
            <ol>
                <li><strong>HTTP Referrer Restriction:</strong> Add your domain to Google Cloud Console</li>
                <li><strong>API Not Enabled:</strong> Enable "Maps JavaScript API" in Google Cloud Console</li>
                <li><strong>Billing Not Set:</strong> Ensure billing is enabled on your Google Cloud project</li>
                <li><strong>Quota Exceeded:</strong> Check your API usage in Google Cloud Console</li>
            </ol>
        </div>

        <div class="info-box">
            <h3>üìã Quick Fix Guide</h3>
            <p><strong>If you see "RefererNotAllowedMapError":</strong></p>
            <ol>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console ‚Üí Credentials</a></li>
                <li>Click on your API key</li>
                <li>Under "Application restrictions", select "HTTP referrers"</li>
                <li>Add this domain: <code id="domainToAdd"></code></li>
                <li>Save and wait 5 minutes</li>
                <li>Clear your browser cache and reload</li>
            </ol>
        </div>
    </div>

    <script>
        // Set current URL info
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('testTime').textContent = new Date().toLocaleString();
        document.getElementById('domainToAdd').textContent = `${window.location.protocol}//${window.location.host}/*`;

        const API_KEY = 'AIzaSyCwm4CExH0_hPj1a59BVcESE4bNrWJOepc';
        let map;
        const testResults = [];

        function addTestResult(name, passed, message) {
            const div = document.createElement('div');
            div.className = `test-item ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${name}</strong>
                <br><small>${message}</small>
            `;
            document.getElementById('testResults').appendChild(div);
            testResults.push({ name, passed, message });
        }

        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function initMap() {
            updateStatus('‚è≥ Loading Google Maps API...', 'loading');
            
            try {
                // Test if google maps is defined
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    updateStatus('‚ùå Google Maps API failed to load', 'error');
                    addTestResult('API Script Load', false, 'google.maps is undefined');
                    return;
                }

                addTestResult('API Script Load', true, 'Google Maps API loaded successfully');

                // Create map
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 35.2174, lng: -80.8346 }, // Charlotte, NC
                    zoom: 13,
                    mapId: 'demo-map'
                });

                addTestResult('Map Initialization', true, 'Map created successfully');

                // Add a marker
                const marker = new google.maps.Marker({
                    position: { lat: 35.2174, lng: -80.8346 },
                    map: map,
                    title: 'Test Marker'
                });

                addTestResult('Marker Creation', true, 'Marker added successfully');

                updateStatus('‚úÖ Google Maps API is working correctly!', 'success');

                // Log success to console
                console.log('‚úÖ All Google Maps tests passed!');
                console.log('Map instance:', map);
                console.log('Google Maps version:', google.maps.version);

            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                addTestResult('Map Initialization', false, error.message);
                console.error('Google Maps Error:', error);
            }
        }

        function gm_authFailure() {
            updateStatus('‚ùå AUTHENTICATION ERROR - API Key Restriction!', 'error');
            addTestResult('API Authentication', false, 'API key is restricted. Check HTTP referrer settings in Google Cloud Console.');
            
            console.error('üö® CRITICAL: API Key Authentication Failed!');
            console.error('This means your API key has HTTP referrer restrictions.');
            console.error('Current domain:', window.location.href);
            console.error('Action required: Add this domain to your API key restrictions in Google Cloud Console');
        }

        // Expose auth failure handler globally
        window.gm_authFailure = gm_authFailure;

        function runDiagnostics() {
            document.getElementById('testResults').innerHTML = '';
            testResults.length = 0;

            console.log('üîç Running Google Maps API Diagnostics...');
            
            // Test 1: Check if running on localhost vs production
            const isLocalhost = window.location.hostname === 'localhost' || 
                                 window.location.hostname === '127.0.0.1';
            addTestResult('Environment Check', true, 
                isLocalhost ? 'Running on localhost' : `Running on ${window.location.hostname}`);

            // Test 2: Check if google is defined
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                addTestResult('Google Maps API Loaded', true, `Version: ${google.maps.version}`);
            } else {
                addTestResult('Google Maps API Loaded', false, 'Google Maps API not loaded');
            }

            // Test 3: Check network connectivity
            fetch(`https://maps.googleapis.com/maps/api/js?key=${API_KEY}`)
                .then(response => {
                    if (response.ok) {
                        addTestResult('Network Connectivity', true, 'Can reach Google Maps API servers');
                    } else {
                        addTestResult('Network Connectivity', false, `HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addTestResult('Network Connectivity', false, error.message);
                });

            console.log('‚úÖ Diagnostics complete. Check results above.');
        }

        function testAPIKey() {
            console.log('üîë Testing API Key:', API_KEY);
            console.log('Current domain:', window.location.href);
            console.log('Protocol:', window.location.protocol);
            console.log('Hostname:', window.location.hostname);
            console.log('Port:', window.location.port);
            
            alert(`API Key Test:\n\nKey: ${API_KEY}\nDomain: ${window.location.hostname}\n\nCheck browser console for details.`);
        }

        function clearCache() {
            if (confirm('This will reload the page and attempt to clear cache. Continue?')) {
                // Try to clear cache and reload
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        names.forEach(function(name) {
                            caches.delete(name);
                        });
                    });
                }
                // Force reload
                window.location.reload(true);
            }
        }

        // Log initial environment info
        console.log('üåç Environment Information:');
        console.log('URL:', window.location.href);
        console.log('Hostname:', window.location.hostname);
        console.log('Protocol:', window.location.protocol);
        console.log('User Agent:', navigator.userAgent);
        console.log('API Key:', API_KEY);
    </script>

    <!-- Load Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwm4CExH0_hPj1a59BVcESE4bNrWJOepc&callback=initMap&v=weekly">
    </script>
</body>
</html>

